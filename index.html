<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shooting Range</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>

    <div id="crosshair"></div>

    <canvas id="bg-canvas"></canvas>
    <canvas id="webgl"></canvas>

    <div id="scoreboard">
      <div class="hud-section score-section">
        <span class="hud-label">PTS</span>
        <span id="score">0</span>
      </div>
      <div class="hud-section timer-section">
        <div class="diamond-shape"></div>
        <div class="timer-content">
          <span id="time">30</span>
        </div>
      </div>
    </div>

    <div id="result-overlay">
      <div class="result-card">
        <h2>SESSION COMPLETE</h2>
        
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Time Played</span>
            <span class="stat-value" id="res-time">30s</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Targets Spawned</span>
            <span class="stat-value" id="res-spawn">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Targets Hit</span>
            <span class="stat-value" id="res-hit">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Shots Missed</span>
            <span class="stat-value" id="res-miss">0</span>
          </div>
          <div class="stat-item full-width">
            <span class="stat-label">Final Score</span>
            <span class="stat-value highlight" id="res-score">0</span>
          </div>
        </div>

        <button id="btn-result-back" class="btn btn-primary">Back to Menu</button>
      </div>
    </div>

    <div id="menu-overlay">
      <div class="menu-card">
        <h1>Aim Trainer</h1>
        <div id="main-menu">
          <button id="btn-play" class="btn btn-primary">Play</button>
          
          <div id="play-modes">
            <button class="btn mode-btn" onclick="selectMode('spidershot')">Spidershot</button>
            <button class="btn mode-btn" onclick="selectMode('motionshot')">Motionshot</button>
          </div>

          <button id="btn-back" class="btn btn-secondary" style="display:none;">Back</button>
          <button id="btn-practice" class="btn btn-secondary">Practice</button>
        </div>
      </div>
    </div>

    <div id="pause-overlay" style="display: none;">
      <div class="menu-card">
        <h1>PAUSED</h1>
        <button id="btn-resume" class="btn btn-primary">Resume</button>
        <button id="btn-restart" class="btn btn-secondary">Restart</button>
        <button id="btn-exit" class="btn btn-secondary">Exit to Menu</button>
      </div>
    </div>

    <div id="countdown">3</div>

    <script type="module" src="ball.js"></script>
    <script type="module" src="background.js"></script>

    <script>
      /* --- VARIABEL UI --- */
      const btnPlay = document.getElementById("btn-play");
      const btnPractice = document.getElementById("btn-practice");
      const btnBack = document.getElementById("btn-back");
      const playModes = document.getElementById("play-modes");
      const countdownEl = document.getElementById("countdown");
      const menuOverlay = document.getElementById("menu-overlay");
      
      // Variable Pause Menu
      const pauseOverlay = document.getElementById("pause-overlay");
      const btnResume = document.getElementById("btn-resume");
      const btnRestart = document.getElementById("btn-restart");
      const btnExit = document.getElementById("btn-exit");

      let isPaused = false;
      let isGameActive = false; // Status apakah sedang dalam sesi permainan
      let activeMode = null;    // Menyimpan mode terakhir untuk fitur Restart

      // --- 1. NAVIGASI MENU UTAMA ---
      btnPlay.addEventListener("click", () => {
        playModes.classList.add("visible");
        btnPlay.style.display = "none";
        btnPractice.style.display = "none";
        btnBack.style.display = "block";
      });

      btnBack.addEventListener("click", () => {
        playModes.classList.remove("visible");
        btnPlay.style.display = "block";
        btnPractice.style.display = "block";
        btnBack.style.display = "none";
      });

      // --- 2. COUNTDOWN SYSTEM ---
      function startCountdown(onFinish) {
        let timeLeft = 3;
        countdownEl.textContent = timeLeft;
        countdownEl.style.display = "block";
        
        // Sembunyikan semua overlay
        menuOverlay.style.opacity = "0";
        menuOverlay.style.pointerEvents = "none";
        pauseOverlay.style.display = "none";

        const interval = setInterval(() => {
          timeLeft--;
          if (timeLeft > 0) {
            countdownEl.textContent = timeLeft;
          } else {
            clearInterval(interval);
            countdownEl.style.display = "none";
            onFinish(); // Panggil fungsi mulai game
          }
        }, 1000);
      }

      // --- 3. PILIH MODE (Dipanggil dari tombol HTML) ---
      window.selectMode = (mode) => {
        activeMode = mode; // Simpan mode yang dipilih
        startCountdown(() => {
          // Memastikan fungsi dari ball.js sudah siap
          if (window.startGame) {
            isGameActive = true;
            window.startGame(mode);
          } else {
            console.error("Fungsi startGame belum dimuat dari ball.js");
          }
        });
      };

      // --- 4. LOGIKA PAUSE MENU ---
      
      // Fungsi ini dipanggil otomatis oleh ball.js saat tombol ESC ditekan
      window.onGamePause = () => {
        // Hanya munculkan pause jika game sedang aktif dan belum dipause
        if (isGameActive && !isPaused) {
           isPaused = true;
           pauseOverlay.style.display = 'flex'; // Munculkan overlay pause
           
           // Beritahu ball.js untuk menghentikan waktu/gerakan
           if(window.setGamePaused) window.setGamePaused(true);
        }
      };

      // Tombol RESUME
      btnResume.addEventListener('click', () => {
        if (isGameActive && isPaused) {
           isPaused = false;
           pauseOverlay.style.display = 'none';
           
           // Kunci kembali kursor mouse (Lanjutkan game FPS)
           const canvas = document.getElementById("webgl");
           canvas.requestPointerLock();
           
           // Lanjutkan waktu/gerakan
           if(window.setGamePaused) window.setGamePaused(false);
        }
      });

      // Tombol RESTART
      btnRestart.addEventListener('click', () => {
         isPaused = false;
         pauseOverlay.style.display = 'none';
         
         // Mulai ulang dengan mode yang sama
         if (activeMode) {
           startCountdown(() => {
             if (window.startGame) window.startGame(activeMode);
           });
         }
      });

      // Tombol EXIT
      btnExit.addEventListener('click', () => {
         // Cara paling bersih untuk reset semua state module JS adalah reload halaman
         window.location.reload(); 
      });

    </script>
  </body>
</html>